# Tracing for HTTP Log

This repo is an example of tracing the same request across multiple services added in this [PR](https://github.com/go-chi/httplog/pull/47).

In the provided examples we have 3 services (main, secondary and tertiary) and calling one triggers subsequent calls to the others.

The trace ID is propagated through a HTTP header, while the span ID is different inside each service. This allows to filter logs for a specific HTTP request across multiple services uinsg the trace, or in a specific one using the span.

You can verify this by running `go run ./cmd/logging`. This is a sample output:

```log
2024-07-13T21:43:43.143369+02:00 INFO main.Server.Run:/Users/klaid/Workspace/Horizon/klaidliadon/logging/cmd/logging/main.go:86 listening service: "trace-id-example" service: "*proto.tertiaryServer" address: "[::]:54693" 
2024-07-13T21:43:43.143759+02:00 INFO main.Server.Run:/Users/klaid/Workspace/Horizon/klaidliadon/logging/cmd/logging/main.go:86 listening service: "trace-id-example" service: "*proto.secondaryServer" address: "[::]:54694" 
2024-07-13T21:43:43.143862+02:00 INFO main.Server.Run:/Users/klaid/Workspace/Horizon/klaidliadon/logging/cmd/logging/main.go:86 listening service: "trace-id-example" service: "*proto.mainServer" address: "[::]:54695" 

2024-07-13T21:43:43.147638+02:00 INFO logging/rpc.Tertiary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:48 tertiary implementation... service: "trace-id-example" logging.googleapis.com/trace: "3cf758b1f7cd48e37907f5dbca957804" logging.googleapis.com/spanId: "ffac1b3e06d2656dde4bc2b7bd4a0153" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000001"} 
2024-07-13T21:43:43.147669+02:00 INFO logging/rpc.Tertiary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:49 tertiary implementation 2 service: "trace-id-example" logging.googleapis.com/trace: "3cf758b1f7cd48e37907f5dbca957804" logging.googleapis.com/spanId: "ffac1b3e06d2656dde4bc2b7bd4a0153" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000001"} 
2024-07-13T21:43:43.147879+02:00 INFO github.com/go-chi/httplog/v2.(*RequestLoggerEntry).Write:/Users/klaid/Library/go/pkg/mod/github.com/klaidliadon/httplog/v2@v2.0.0-20240713193818-042ce387ceb2/httplog.go:172 Response: 200 OK service: "trace-id-example" logging.googleapis.com/trace: "3cf758b1f7cd48e37907f5dbca957804" logging.googleapis.com/spanId: "ffac1b3e06d2656dde4bc2b7bd4a0153" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000001"} httpResponse: {status: 200 bytes: 11 elapsed: 0.234375} 

2024-07-13T21:43:43.148741+02:00 INFO logging/rpc.Secondary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:34 secondary implementation... service: "trace-id-example" logging.googleapis.com/trace: "bc69959dccc54c20538dc2db4fcc7fbc" logging.googleapis.com/spanId: "5a460b39e4d36362cbbad0de1070da81" httpRequest: {url: "http://localhost:54694/rpc/Secondary/Do" method: "POST" path: "/rpc/Secondary/Do" remoteIP: "[::1]:54697" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000002"} 
2024-07-13T21:43:43.148915+02:00 INFO logging/rpc.Tertiary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:48 tertiary implementation... service: "trace-id-example" logging.googleapis.com/trace: "bc69959dccc54c20538dc2db4fcc7fbc" logging.googleapis.com/spanId: "11972a55ddd7878b8a964edb4e9ad660" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000003"} 
2024-07-13T21:43:43.148928+02:00 INFO logging/rpc.Tertiary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:49 tertiary implementation 2 service: "trace-id-example" logging.googleapis.com/trace: "bc69959dccc54c20538dc2db4fcc7fbc" logging.googleapis.com/spanId: "11972a55ddd7878b8a964edb4e9ad660" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000003"} 
2024-07-13T21:43:43.149196+02:00 INFO github.com/go-chi/httplog/v2.(*RequestLoggerEntry).Write:/Users/klaid/Library/go/pkg/mod/github.com/klaidliadon/httplog/v2@v2.0.0-20240713193818-042ce387ceb2/httplog.go:172 Response: 200 OK service: "trace-id-example" logging.googleapis.com/trace: "bc69959dccc54c20538dc2db4fcc7fbc" logging.googleapis.com/spanId: "11972a55ddd7878b8a964edb4e9ad660" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000003"} httpResponse: {status: 200 bytes: 11 elapsed: 0.275000} 
2024-07-13T21:43:43.149341+02:00 INFO logging/rpc.Secondary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:38 secondary implementation complete! service: "trace-id-example" logging.googleapis.com/trace: "bc69959dccc54c20538dc2db4fcc7fbc" logging.googleapis.com/spanId: "5a460b39e4d36362cbbad0de1070da81" httpRequest: {url: "http://localhost:54694/rpc/Secondary/Do" method: "POST" path: "/rpc/Secondary/Do" remoteIP: "[::1]:54697" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000002"} 
2024-07-13T21:43:43.149368+02:00 INFO github.com/go-chi/httplog/v2.(*RequestLoggerEntry).Write:/Users/klaid/Library/go/pkg/mod/github.com/klaidliadon/httplog/v2@v2.0.0-20240713193818-042ce387ceb2/httplog.go:172 Response: 200 OK service: "trace-id-example" logging.googleapis.com/trace: "bc69959dccc54c20538dc2db4fcc7fbc" logging.googleapis.com/spanId: "5a460b39e4d36362cbbad0de1070da81" httpRequest: {url: "http://localhost:54694/rpc/Secondary/Do" method: "POST" path: "/rpc/Secondary/Do" remoteIP: "[::1]:54697" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000002"} httpResponse: {status: 200 bytes: 11 elapsed: 0.624000} 

2024-07-13T21:43:43.149998+02:00 INFO logging/rpc.Main.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:18 main implementation... service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "59b84398ca3c3d8ab500e915711c9e18" httpRequest: {url: "http://localhost:54695/rpc/Main/Do" method: "POST" path: "/rpc/Main/Do" remoteIP: "[::1]:54698" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000004"} 
2024-07-13T21:43:43.150146+02:00 INFO logging/rpc.Secondary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:34 secondary implementation... service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "555885edca3e95d81d7018938aa356f2" httpRequest: {url: "http://localhost:54694/rpc/Secondary/Do" method: "POST" path: "/rpc/Secondary/Do" remoteIP: "[::1]:54697" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000005"} 
2024-07-13T21:43:43.150289+02:00 INFO logging/rpc.Tertiary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:48 tertiary implementation... service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "360489353291714d5461a88022dc1a09" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000006"} 
2024-07-13T21:43:43.15042+02:00 INFO logging/rpc.Tertiary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:49 tertiary implementation 2 service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "360489353291714d5461a88022dc1a09" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000006"} 
2024-07-13T21:43:43.150479+02:00 INFO github.com/go-chi/httplog/v2.(*RequestLoggerEntry).Write:/Users/klaid/Library/go/pkg/mod/github.com/klaidliadon/httplog/v2@v2.0.0-20240713193818-042ce387ceb2/httplog.go:172 Response: 200 OK service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "360489353291714d5461a88022dc1a09" httpRequest: {url: "http://localhost:54693/rpc/Tertiary/Do" method: "POST" path: "/rpc/Tertiary/Do" remoteIP: "[::1]:54696" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000006"} httpResponse: {status: 200 bytes: 11 elapsed: 0.178750} 
2024-07-13T21:43:43.150581+02:00 INFO logging/rpc.Secondary.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:38 secondary implementation complete! service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "555885edca3e95d81d7018938aa356f2" httpRequest: {url: "http://localhost:54694/rpc/Secondary/Do" method: "POST" path: "/rpc/Secondary/Do" remoteIP: "[::1]:54697" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000005"} 
2024-07-13T21:43:43.150602+02:00 INFO github.com/go-chi/httplog/v2.(*RequestLoggerEntry).Write:/Users/klaid/Library/go/pkg/mod/github.com/klaidliadon/httplog/v2@v2.0.0-20240713193818-042ce387ceb2/httplog.go:172 Response: 200 OK service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "555885edca3e95d81d7018938aa356f2" httpRequest: {url: "http://localhost:54694/rpc/Secondary/Do" method: "POST" path: "/rpc/Secondary/Do" remoteIP: "[::1]:54697" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000005"} httpResponse: {status: 200 bytes: 11 elapsed: 0.455167} 
2024-07-13T21:43:43.15069+02:00 INFO logging/rpc.Main.Do:/Users/klaid/Workspace/Horizon/klaidliadon/logging/rpc/rpc.go:22 main implementation 2 service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "59b84398ca3c3d8ab500e915711c9e18" httpRequest: {url: "http://localhost:54695/rpc/Main/Do" method: "POST" path: "/rpc/Main/Do" remoteIP: "[::1]:54698" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000004"} 
2024-07-13T21:43:43.150724+02:00 INFO github.com/go-chi/httplog/v2.(*RequestLoggerEntry).Write:/Users/klaid/Library/go/pkg/mod/github.com/klaidliadon/httplog/v2@v2.0.0-20240713193818-042ce387ceb2/httplog.go:172 Response: 200 OK service: "trace-id-example" logging.googleapis.com/trace: "49da313a102e9f5f705a1327ad3e5eb5" logging.googleapis.com/spanId: "59b84398ca3c3d8ab500e915711c9e18" httpRequest: {url: "http://localhost:54695/rpc/Main/Do" method: "POST" path: "/rpc/Main/Do" remoteIP: "[::1]:54698" proto: "HTTP/1.1" requestID: "Shield.local/tGYtzRztQL-000004"} httpResponse: {status: 200 bytes: 11 elapsed: 0.718625} 
```

You can see that the first request is sent to tertiary service. The trace ID is `3cf758b1f7cd48e37907f5dbca957804` and the span ID is `ffac1b3e06d2656dde4bc2b7bd4a0153`. It does not propagate.

The second request is sent to the secondary service. It creates the trace `bc69959dccc54c20538dc2db4fcc7fbc` and the span `5a460b39e4d36362cbbad0de1070da81`. It sends a request to the tertiary service propagating the same trace and creating a new span `11972a55ddd7878b8a964edb4e9ad660`.

The third request is to the main service. It creates the trace `49da313a102e9f5f705a1327ad3e5eb5` which is progated through secondary and tertiary service. In each service there is a different span: `59b84398ca3c3d8ab500e915711c9e18`, `555885edca3e95d81d7018938aa356f2`, `360489353291714d5461a88022dc1a09`.